name: Prod Promotion PR

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: prod-promotion-pr
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  ensure-prod-promotion-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Ensure main -> prod PR exists and is up to date
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROD_PROMOTION_TOKEN != '' && secrets.PROD_PROMOTION_TOKEN || github.token }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const title = "Promote main to prod";
            const body = [
              "## Summary",
              "- Promotes the latest `main` commits into `prod` for Railway production deployment.",
              "",
              "## Deployment Checklist",
              "- [ ] `Release Verification` check is green",
              "- [ ] Product/QA sign-off is complete",
              "- [ ] No blockers remain for production rollout",
              "",
              "## Notes",
              "- This PR is managed automatically.",
              "- New merges to `main` are reflected automatically because this PR compares `main` into `prod`.",
            ].join("\n");

            const openPrs = await github.rest.pulls.list({
              owner,
              repo,
              state: "open",
              base: "prod",
              head: `${owner}:main`,
              per_page: 1,
            });

            if (openPrs.data.length > 0) {
              const pr = openPrs.data[0];
              await github.rest.pulls.update({
                owner,
                repo,
                pull_number: pr.number,
                title,
                body,
              });
              core.info(`Updated existing prod promotion PR #${pr.number}`);
              return;
            }

            const created = await github.rest.pulls.create({
              owner,
              repo,
              title,
              head: "main",
              base: "prod",
              body,
              maintainer_can_modify: true,
            });

            core.info(`Created prod promotion PR #${created.data.number}`);
